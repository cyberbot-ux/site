<!DOCTYPE html>
<html>
  <head>
    <title>Review Order</title>
    <link rel="stylesheet" href="css/page_css.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/print-js/1.6.0/print.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/print-js/1.6.0/print.min.css" />
  </head>
  <body>
    <div class="page-container">
      <h2>üìù Review Your Order</h2>

      <div id="printArea">
        <div id="orderDisplay"></div>
      </div>

      <div class="button-group">
        <a class="btn" href="index.html">‚¨ÖÔ∏è Go Back</a>
        <button class="btn" onclick="confirmOrder()">‚úÖ Confirm</button>
        <button class="btn" onclick="exportToExcel()">üìä Excel</button>
        <button class="btn" onclick="printOnlyTable()">üñ®Ô∏è PDF</button>
      </div>
    </div>

    <script>
      const orders = JSON.parse(localStorage.getItem("orderToSubmit") || "[]");
      const displayDiv = document.getElementById("orderDisplay");

      const grouped = {};
      orders.forEach((order) => {
        const cat = order.category || "Uncategorized";
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push(order);
      });

      let html = "";
      let rowIndex = 1;
      for (const category in grouped) {
        html += `<h3>${category}</h3>`;
        html += `<table><thead><tr><th>#</th><th>Item</th><th>Quantity</th></tr></thead><tbody>`;
        grouped[category].forEach((item) => {
          html += `<tr><td>${rowIndex++}</td><td>${item.name}</td><td>${item.quantity}</td></tr>`;
        });
        html += "</tbody></table>";
      }
      displayDiv.innerHTML = html;

      function confirmOrder() {
        const history = JSON.parse(localStorage.getItem("orderHistory") || "[]");
        history.unshift({
          timestamp: new Date().toLocaleString(),
          items: orders,
        });
        localStorage.setItem("orderHistory", JSON.stringify(history));
        localStorage.removeItem("orderToSubmit");
        alert("‚úÖ Order confirmed and saved!");
        window.location.href = "order.html";
      }

      function exportToExcel() {
        const sheetData = [["#", "Item", "Quantity", "Category"]];
        orders.forEach((item, i) => {
          sheetData.push([i + 1, item.name, item.quantity, item.category]);
        });
        const ws = XLSX.utils.aoa_to_sheet(sheetData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Order");
        XLSX.writeFile(wb, "Order_Review.xlsx");
      }

      function printOnlyTable() {
        printJS({
          printable: "printArea",
          type: "html",
          targetStyles: ["*"],
        });
      }
    </script>
  </body>
</html>
